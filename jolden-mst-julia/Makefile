PROGRAM = mst

MAIN_CLASS = mst.MST

SHELL = /bin/bash

JAVA_HOME ?= $(dirname $(dirname $(dirname $(readlink -f $(/usr/bin/which java)))))

RT_JAR = $(JAVA_HOME)/jre/lib/rt.jar

DEPENDENCIES_FOLDER = ../dependencies

DEPENDENCIES_REORGANIZED_FOLDER = ../dependencies-reorganized

ANNOTATION_TOOLS_FOLDER = \
			  $(DEPENDENCIES_FOLDER)/annotation-file-utilities-releases/annotation-tools

JSR308_LANGTOOLS_FOLDER = \
			  $(DEPENDENCIES_FOLDER)/jsr308-langtools-releases/jsr308-langtools

CHECKER_FRAMEWORK_FOLDER = \
			   $(DEPENDENCIES_FOLDER)/checker-framework-releases/checker-framework

JULIA_FOLDER = $(DEPENDENCIES_FOLDER)/julia-releases

JULIA_JARS = $(shell echo $(JULIA_FOLDER)/binaries/*.jar | tr ' ' ':')

INSERT_ANNOTATIONS_TO_SOURCE = \
			       $(DEPENDENCIES_REORGANIZED_FOLDER)/annotation-tools/annotation-file-utilities/scripts/insert-annotations-to-source

SRC_FOLDER = src/$(PROGRAM)

AUTOMATICALLY_ANNOTATED_SRC_PARENT_FOLDER ?= automatically-jaifed-src

AUTOMATICALLY_ANNOTATED_SRC_FOLDER ?= \
				      $(AUTOMATICALLY_ANNOTATED_SRC_PARENT_FOLDER)/$(PROGRAM)

SRC_FOLDER_COPY ?= src-copy

CLASS_FOLDER = bin

AUTOMATICALLY_ANNOTATED_CLASS_FOLDER ?= automatically-jaifed-bin

MANUALLY_ANNOTATED_CLASS_FOLDER ?= automatically-jaifed-fixed-bin

JAVA_FILES = $(wildcard $(SRC_FOLDER)/*.java)

AUTOMATICALLY_ANNOTATED_JAVA_FILES = $(addprefix \
				     $(AUTOMATICALLY_ANNOTATED_SRC_FOLDER)/, \
				     $(notdir $(JAVA_FILES)))

JAVA_FILES_COPY = $(addprefix $(SRC_FOLDER_COPY)/, $(notdir $(JAVA_FILES)))

JAIF_FOLDER = juliaOutput

JAIF_FILE = $(JAIF_FOLDER)/nullness.jaif

AUTOMATIC_JAR_FILE = $(PROGRAM)-automatic.jar

MANUAL_JAR_FILE = $(PROGRAM)-manual.jar

CP = cp

MV = mv

RM = rm

MKDIR = mkdir

JAVAC = $(DEPENDENCIES_REORGANIZED_FOLDER)/checker-framework/checker/bin/javac

JAVAC_OPTS = -Awarns -processor\
	     org.checkerframework.checker.nullness.NullnessChecker

JAR = jar

JAR_OPTS = cfe

JAVA = java

JAVA_OPTS = -ea

all: $(AUTOMATIC_JAR_FILE)

$(DEPENDENCIES_REORGANIZED_FOLDER): $(ANNOTATION_TOOLS_FOLDER) \
	$(JSR308_LANGTOOLS_FOLDER) $(CHECKER_FRAMEWORK_FOLDER) \

	$(MKDIR) -p $(DEPENDENCIES_REORGANIZED_FOLDER)

	$(CP) -r $(ANNOTATION_TOOLS_FOLDER) $(DEPENDENCIES_REORGANIZED_FOLDER)

	$(CP) -r $(JSR308_LANGTOOLS_FOLDER) $(DEPENDENCIES_REORGANIZED_FOLDER)

	$(CP) -r $(CHECKER_FRAMEWORK_FOLDER) $(DEPENDENCIES_REORGANIZED_FOLDER)

$(MANUAL_JAR_FILE): $(JAVA_FILES)

	$(MKDIR) -p $(CLASS_FOLDER)

	$(JAVAC) $(JAVAC_OPTS) -d $(CLASS_FOLDER) $(JAVA_FILES)

	$(JAR) $(JAR_OPTS) $(MANUAL_JAR_FILE) $(MAIN_CLASS) -C $(CLASS_FOLDER) .

$(JAIF_FILE): $(MANUAL_JAR_FILE)

	time $(JAVA) -Xmx1G -classpath $(JULIA_JARS)\
		com.juliasoft.julia.engine.Julia -si $(MANUAL_JAR_FILE) -i\
		java. -framework java -Nullness list jaif

	sed -i \
		"s/checkers.nullness.quals/org.checkerframework.checker.nullness.qual/"\
		$(JAIF_FILE)

$(AUTOMATICALLY_ANNOTATED_JAVA_FILES): $(DEPENDENCIES_REORGANIZED_FOLDER) \
	$(JAVA_FILES) $(JAIF_FILE)

	$(MKDIR) -p $(AUTOMATICALLY_ANNOTATED_SRC_FOLDER)

	$(CP) -r $(SRC_FOLDER)/* $(AUTOMATICALLY_ANNOTATED_SRC_FOLDER)
        
	CLASSPATH=$(CLASS_FOLDER) $(INSERT_ANNOTATIONS_TO_SOURCE) \
		  --in-place=true $(JAIF_FILE) \
		  $(AUTOMATICALLY_ANNOTATED_JAVA_FILES)

$(AUTOMATIC_JAR_FILE): $(AUTOMATICALLY_ANNOTATED_JAVA_FILES)

	$(MKDIR) -p $(AUTOMATICALLY_ANNOTATED_CLASS_FOLDER)

	$(JAVAC) $(JAVAC_OPTS) -d $(AUTOMATICALLY_ANNOTATED_CLASS_FOLDER) \
		$(AUTOMATICALLY_ANNOTATED_JAVA_FILES)

	$(JAR) $(JAR_OPTS) $(AUTOMATIC_JAR_FILE) $(MAIN_CLASS) -C \
		$(AUTOMATICALLY_ANNOTATED_CLASS_FOLDER) .

run-automatic : $(AUTOMATIC_JAR_FILE)

	$(JAVA) $(JAVA_OPTS) -jar $(AUTOMATIC_JAR_FILE) $(PROGRAM_ARGS)

clean:

	$(RM) -rf $(DEPENDENCIES_REORGANIZED_FOLDER) \
		$(AUTOMATICALLY_ANNOTATED_SRC_PARENT_FOLDER) \
		$(AUTOMATICALLY_ANNOTATED_CLASS_FOLDER) \
		$(MANUALLY_ANNOTATED_CLASS_FOLDER) $(AUTOMATIC_JAR_FILE) \
		$(SRC_FOLDER_COPY) $(JAIF_FOLDER) $(CLASS_FOLDER) \
		$(MANUAL_JAR_FILE)

